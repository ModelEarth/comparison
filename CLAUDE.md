# Guidance

CLAUDE.md

### Data Files

For each country and year, there are 8 files generated by the exibase/tradeflow python to use in the dynamic comparison reports.  
These reside in each year folder in the [trade-data repo](https://github.com/ModelEarth/trade-data/tree/main/year) at trade-data/[year]/[country]

Two of the files reside external to the country folders: [factor.csv](https://github.com/ModelEarth/trade-data/blob/main/year/2019/factor.csv) and [industry.csv](https://github.com/ModelEarth/trade-data/blob/main/year/2019/industry.csv)

Join those to each country's six annual tradeflow files in the [year]/[country] folder at:

imports/trade.csv
imports/trade_factor.csv
exports/trade.csv
exports/trade_factor.csv
domestic/trade.csv
domestic/trade_factor.csv

These files above will also be used as table names in an SQL database instance for each year.

Other files are redundant and reproduce what's in the trade_factor.csv files above.
The exception is files starting with bea, which contain US state data.


### CSS Style

Include our tailwind compliant css style sheet:

localsite/css/styles/notion.css

The style samples can be viewed at:
https://model.earth/localsite/css/styles/


### Map Integration

Use the map javascript in [team/projects/map/](../team/projects/map/#map=dca)

### Country Select (Legend)

Our country legend resides in the [timeline](../localsite/timeline/) javascript


### Separated-Chord Chart

The following separated-chord chart is good to reuse for comparing industries (sectors) and impacts (indicators):
[/profile/footprint/sector_supply_impacts.html](/profile/footprint/sector_supply_impacts.html)

Keep the separated-chord javascript in its existing location at:
/profile/footprint/chord/stretched/chordInit.js
/profile/footprint/chord/stretched/script.js


These files will also be used as table names in an SQL instance for each year.


# Guide for Reusability and development - Antariksh (12/17/2025)

# International Comparison Dashboard - AI Development Guide

## Overview
This comprehensive guide provides AI assistants (like Claude) with complete documentation for generating consistent, high-quality comparison visualizations using EXIOBASE tradeflow data. It includes actual code implementations extracted from the successful Antariksh experiment, reusable chart components, UI patterns, and best practices.

**Purpose:** Enable anyone (AI or human) to create new comparison pages or extend existing ones with consistent quality and design patterns.

---

## Table of Contents
1. [Data Structure](#data-structure)
2. [Core Configuration](#core-configuration)
3. [Reusable Chart Components](#reusable-chart-components)
4. [UI/UX Patterns](#uiux-patterns)
5. [Data Processing Functions](#data-processing-functions)
6. [Performance & Debugging](#performance--debugging)
7. [Integration Guidelines](#integration-guidelines)
8. [Quick Reference](#quick-reference)

---

## Data Structure

### Repository Information
**Base URL:** `https://raw.githubusercontent.com/ModelEarth/trade-data/main/year/2019`

### File Organization

There are **6 tradeflow files** per country (3 flows √ó 2 file types) plus 2 reference files:

**Reference Files (Year Level):**
```
/year/2019/factor.csv      - Environmental factor definitions and extensions
/year/2019/industry.csv    - Industry category definitions and mappings
```

**Per-Country Tradeflow Files:**
```
/year/2019/{COUNTRY_CODE}/domestic/trade.csv
/year/2019/{COUNTRY_CODE}/domestic/trade_factor.csv
/year/2019/{COUNTRY_CODE}/exports/trade.csv
/year/2019/{COUNTRY_CODE}/exports/trade_factor.csv
/year/2019/{COUNTRY_CODE}/imports/trade.csv
/year/2019/{COUNTRY_CODE}/imports/trade_factor.csv
```

**Important Note:** Other files in the dataset are redundant and should not be loaded. The exception is files starting with "bea" which contain US state-level data (not used in country-level comparisons).

### Available Countries (14 Total)

```javascript
const AVAILABLE_COUNTRIES = [
    'US',  // United States
    'CA',  // Canada
    'BR',  // Brazil
    'GB',  // United Kingdom
    'DE',  // Germany
    'FR',  // France
    'IT',  // Italy
    'RU',  // Russia
    'CN',  // China
    'JP',  // Japan
    'IN',  // India
    'KR',  // South Korea
    'AU',  // Australia
    'WM'   // Middle East (aggregate)
];
```

**‚ö†Ô∏è CRITICAL WARNING:** Only request data for these 14 countries. Requesting non-existent countries causes 404 errors that can create infinite retry loops and crash the browser.

### File Schema Reference

**factor.csv:**
- `factor_id` - Unique factor identifier
- `name` - Factor name (e.g., "CO2 emissions")
- `extension` - Category extension (e.g., "Air", "Water use", "Employment")
- `unit` - Measurement unit

**industry.csv:**
- `industry_id` - Unique industry identifier
- `name` - Industry name
- `category` - Industry category grouping

**trade.csv:**
- `trade_id` - Unique trade record identifier
- `industry_id` - Links to industry.csv
- `value` - Trade value/volume
- `origin` - Origin country code
- `destination` - Destination country code

**trade_factor.csv:**
- `trade_id` - Links to trade.csv
- `factor_id` - Links to factor.csv
- `impact_value` - Environmental impact measurement

---

## Core Configuration

### Country Configuration Object

Complete configuration with coordinates, colors, and metadata:

```javascript
const COUNTRIES = {
    US: { 
        name: 'United States', 
        coords: [37.09, -95.71], 
        flag: 'üá∫üá∏', 
        color: '#4A90E2', 
        region: 'Americas' 
    },
    CA: { 
        name: 'Canada', 
        coords: [56.13, -106.35], 
        flag: 'üá®üá¶', 
        color: '#E74C3C', 
        region: 'Americas' 
    },
    BR: { 
        name: 'Brazil', 
        coords: [-14.24, -51.93], 
        flag: 'üáßüá∑', 
        color: '#27AE60', 
        region: 'Americas' 
    },
    GB: { 
        name: 'United Kingdom', 
        coords: [55.38, -3.44], 
        flag: 'üá¨üáß', 
        color: '#3498DB', 
        region: 'Europe' 
    },
    DE: { 
        name: 'Germany', 
        coords: [51.17, 10.45], 
        flag: 'üá©üá™', 
        color: '#9B59B6', 
        region: 'Europe' 
    },
    FR: { 
        name: 'France', 
        coords: [46.23, 2.21], 
        flag: 'üá´üá∑', 
        color: '#E67E22', 
        region: 'Europe' 
    },
    IT: { 
        name: 'Italy', 
        coords: [41.87, 12.57], 
        flag: 'üáÆüáπ', 
        color: '#1ABC9C', 
        region: 'Europe' 
    },
    RU: { 
        name: 'Russia', 
        coords: [61.52, 105.31], 
        flag: 'üá∑üá∫', 
        color: '#C0392B', 
        region: 'Europe' 
    },
    CN: { 
        name: 'China', 
        coords: [35.86, 104.20], 
        flag: 'üá®üá≥', 
        color: '#E74C3C', 
        region: 'Asia' 
    },
    JP: { 
        name: 'Japan', 
        coords: [36.20, 138.25], 
        flag: 'üáØüáµ', 
        color: '#F39C12', 
        region: 'Asia' 
    },
    IN: { 
        name: 'India', 
        coords: [20.59, 78.96], 
        flag: 'üáÆüá≥', 
        color: '#16A085', 
        region: 'Asia' 
    },
    KR: { 
        name: 'South Korea', 
        coords: [35.91, 127.77], 
        flag: 'üá∞üá∑', 
        color: '#8E44AD', 
        region: 'Asia' 
    },
    AU: { 
        name: 'Australia', 
        coords: [-25.27, 133.78], 
        flag: 'üá¶üá∫', 
        color: '#D35400', 
        region: 'Oceania' 
    },
    WM: { 
        name: 'Middle East', 
        coords: [29.31, 47.48], 
        flag: 'üåç', 
        color: '#7F8C8D', 
        region: 'Middle East' 
    }
};
```

### Factor Group Mapping

Maps factor extensions to environmental categories:

```javascript
const FACTOR_GROUP_MAPPING = {
    'air': [
        'Air', 
        'Emissions to air', 
        'GHG emissions', 
        'CO2', 
        'CH4', 
        'N2O', 
        'NOx', 
        'SOx',
        'PM10',
        'PM2.5'
    ],
    'water': [
        'Water', 
        'Emissions to water', 
        'Water use', 
        'Water consumption',
        'Water_Blue',
        'Water_Green'
    ],
    'energy': [
        'Energy', 
        'Energy use', 
        'Energy Carrier', 
        'Electricity', 
        'Heat',
        'Fossil'
    ],
    'land': [
        'Land', 
        'Land use', 
        'Land_Arable', 
        'Land_Forest', 
        'Land_Pasture',
        'Land_Urban'
    ],
    'materials': [
        'Materials', 
        'Material use', 
        'Resources', 
        'Biomass', 
        'Metal', 
        'Non_Metal',
        'Minerals'
    ],
    'employment': [
        'Employment', 
        'Labour', 
        'Employment_Low', 
        'Employment_Medium', 
        'Employment_High',
        'Jobs'
    ]
};

/**
 * Maps a factor extension to its environmental group
 * @param {string} extension - Factor extension from factor.csv
 * @returns {string} - Environmental group name or 'other'
 */
function getFactorGroup(extension) {
    if (!extension) return 'other';
    
    const extLower = extension.toLowerCase();
    
    for (const [group, keywords] of Object.entries(FACTOR_GROUP_MAPPING)) {
        for (const keyword of keywords) {
            if (extLower.includes(keyword.toLowerCase())) {
                return group;
            }
        }
    }
    
    return 'other';
}
```

### Global State Variables

```javascript
// Data paths
const DATA_BASE_PATH = 'https://raw.githubusercontent.com/ModelEarth/trade-data/main/year/2019';
const TRADE_FLOWS = ['domestic', 'exports', 'imports'];

// Application state
let selectedCountries = new Set(['US']); // Default: USA selected
let currentFactorGroup = 'air'; // Default environmental factor
let dataLoadingComplete = false;
let loadingErrors = [];

// Data storage
let industryLookup = {}; // Maps industry_id -> industry data
let factorLookup = {};   // Maps factor_id -> factor data
let tradeData = {};      // Maps country_code -> flow -> {trade, trade_factor}
let tradeLookup = {};    // Maps trade_id -> trade data (for quick lookup)

// UI instances
let map;                 // Leaflet map instance
let markers = {};        // Map markers by country code
let charts = {};         // ECharts instances by chart name
```

---

## Reusable Chart Components

This section contains production-ready code blocks that can be copied and adapted for any comparison page.

### 1. Country Comparison Bar Chart

**Purpose:** Compare environmental impact totals across selected countries

**Dependencies:** ECharts

**HTML:**
```html
<div class="chart-container">
    <h3>üåç Country Comparison</h3>
    <div id="chart-comparison" style="width: 100%; height: 400px;"></div>
</div>
```

**JavaScript:**
```javascript
function updateComparisonChart() {
    const chartDiv = document.getElementById('chart-comparison');
    if (!chartDiv) return;
    
    if (!charts.comparison) {
        charts.comparison = echarts.init(chartDiv);
    }

    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) {
        charts.comparison.clear();
        return;
    }
    
    const data = countries.map(code => ({
        name: COUNTRIES[code].name,
        code: code,
        value: calculateTotalForCountry(code, currentFactorGroup),
        itemStyle: { 
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: COUNTRIES[code].color },
                { offset: 1, color: COUNTRIES[code].color + 'cc' }
            ]),
            shadowBlur: 10,
            shadowColor: COUNTRIES[code].color + '40',
            shadowOffsetY: 5
        }
    }));

    const option = {
        animationDuration: 1500,
        animationEasing: 'elasticOut',
        backgroundColor: 'transparent',
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            top: '8%',
            containLabel: true
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: params => {
                const p = params[0];
                const code = data[p.dataIndex].code;
                const flagClass = code === 'WM' ? '' : 
                    `<span class="fi fi-${code.toLowerCase()}" style="width:20px;height:15px;margin-right:8px;"></span>`;
                return `${flagClass}<strong>${p.name}</strong><br/>${formatNumber(p.value)}`;
            },
            backgroundColor: 'rgba(50,50,50,0.9)',
            borderColor: '#333',
            borderWidth: 1,
            textStyle: { color: '#fff', fontSize: 13 },
            padding: 12
        },
        xAxis: {
            type: 'category',
            data: data.map(d => d.code + '\n' + d.name.split(' ')[0]),
            axisLabel: { 
                interval: 0, 
                rotate: countries.length > 4 ? 25 : 0,
                color: '#666',
                fontSize: 11,
                fontWeight: 500
            },
            axisLine: { lineStyle: { color: '#ddd', width: 2 } }
        },
        yAxis: {
            type: 'value',
            name: 'Total Impact',
            nameTextStyle: { fontSize: 12, fontWeight: 600, color: '#333' },
            axisLabel: { 
                formatter: value => formatNumber(value),
                color: '#666',
                fontSize: 11
            },
            splitLine: { lineStyle: { color: '#f0f0f0', width: 1 } }
        },
        series: [{
            type: 'bar',
            data: data,
            barWidth: '50%',
            barMaxWidth: 60,
            emphasis: {
                itemStyle: {
                    shadowBlur: 20,
                    shadowColor: 'rgba(0,0,0,0.3)'
                }
            }
        }]
    };

    charts.comparison.setOption(option, true);
}
```

**Features:**
- ‚úÖ Gradient colored bars
- ‚úÖ Country-specific colors
- ‚úÖ Shadow effects on hover
- ‚úÖ Country flags in tooltips
- ‚úÖ Auto-rotate labels when many countries
- ‚úÖ Responsive layout

---

### 2. Trade Flow Breakdown - Stacked Bar Chart

**Purpose:** Show domestic vs exports vs imports for each country

**Dependencies:** ECharts

**HTML:**
```html
<div class="chart-container">
    <h3>üìä Trade Flow Breakdown</h3>
    <div id="chart-tradeflow" style="width: 100%; height: 400px;"></div>
</div>
```

**JavaScript:**
```javascript
function updateTradeflowChart() {
    const chartDiv = document.getElementById('chart-tradeflow');
    if (!chartDiv) return;
    
    if (!charts.tradeflow) {
        charts.tradeflow = echarts.init(chartDiv);
    }

    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) {
        charts.tradeflow.clear();
        return;
    }
    
    const flows = ['domestic', 'exports', 'imports'];
    const seriesData = flows.map(flow => ({
        name: flow.charAt(0).toUpperCase() + flow.slice(1),
        type: 'bar',
        stack: 'total',
        data: countries.map(code => calculateTotalByFlow(code, currentFactorGroup, flow)),
        itemStyle: {
            color: flow === 'domestic' ? '#3b82f6' : 
                   flow === 'exports' ? '#10b981' : '#f59e0b'
        },
        emphasis: {
            itemStyle: {
                shadowBlur: 10,
                shadowOffsetY: 5,
                shadowColor: 'rgba(0,0,0,0.3)'
            }
        }
    }));

    const option = {
        backgroundColor: 'transparent',
        animationDuration: 1200,
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: params => {
                let html = `<strong>${params[0].axisValue}</strong><br/>`;
                let total = 0;
                params.forEach(p => {
                    html += `${p.marker} ${p.seriesName}: ${formatNumber(p.value)}<br/>`;
                    total += p.value;
                });
                html += `<strong>Total: ${formatNumber(total)}</strong>`;
                return html;
            },
            backgroundColor: 'rgba(50,50,50,0.9)',
            borderColor: '#333',
            textStyle: { color: '#fff' }
        },
        legend: {
            data: flows.map(f => f.charAt(0).toUpperCase() + f.slice(1)),
            bottom: 5,
            left: 'center',
            itemGap: 20,
            textStyle: { fontSize: 12, fontWeight: 500 }
        },
        grid: {
            left: '3%',
            right: '4%',
            bottom: '15%',
            top: '5%',
            containLabel: true
        },
        xAxis: {
            type: 'category',
            data: countries.map(code => COUNTRIES[code].name),
            axisLabel: { 
                rotate: countries.length > 4 ? 20 : 0,
                color: '#666',
                fontSize: 11
            }
        },
        yAxis: {
            type: 'value',
            name: 'Impact Value',
            axisLabel: { formatter: value => formatNumber(value) }
        },
        series: seriesData
    };

    charts.tradeflow.setOption(option, true);
}
```

**Color Scheme:**
- üîµ **Domestic:** `#3b82f6` (Blue)
- üü¢ **Exports:** `#10b981` (Green)
- üü† **Imports:** `#f59e0b` (Orange)

**Features:**
- ‚úÖ Stacked bars showing flow composition
- ‚úÖ Total shown in tooltip
- ‚úÖ Legend positioned outside chart area
- ‚úÖ Consistent color coding

---

### 3. Industry Breakdown Chart

**Purpose:** Show impact distribution across industry categories

**Dependencies:** ECharts

**HTML:**
```html
<div class="chart-container">
    <h3>üè≠ Industry Breakdown</h3>
    <p class="chart-subtitle">Top 15 industries by environmental impact</p>
    <div id="chart-industry" style="width: 100%; height: 500px;"></div>
</div>
```

**JavaScript:**
```javascript
function updateIndustryChart() {
    const chartDiv = document.getElementById('chart-industry');
    if (!chartDiv) return;
    
    if (!charts.industry) {
        charts.industry = echarts.init(chartDiv);
    }

    const countries = Array.from(selectedCountries);
    
    if (countries.length === 0) {
        charts.industry.clear();
        return;
    }

    // Aggregate by industry across all selected countries
    const industryTotals = {};
    
    countries.forEach(code => {
        if (!COUNTRIES[code]) return;
        
        ['domestic', 'exports', 'imports'].forEach(flow => {
            if (tradeData[code] && tradeData[code][flow]) {
                const tradeRows = tradeData[code][flow].trade || [];
                const factorRows = tradeData[code][flow].trade_factor || [];
                
                tradeRows.forEach(trade => {
                    const industry = industryLookup[trade.industry_id];
                    if (!industry) return;
                    
                    const industryName = industry.name || 'Unknown';
                    if (!industryTotals[industryName]) {
                        industryTotals[industryName] = 0;
                    }
                    
                    // Sum impacts for this trade
                    factorRows
                        .filter(f => f.trade_id === trade.trade_id)
                        .forEach(factorRow => {
                            const factor = factorLookup[factorRow.factor_id];
                            if (factor && getFactorGroup(factor.extension) === currentFactorGroup) {
                                industryTotals[industryName] += parseFloat(factorRow.impact_value) || 0;
                            }
                        });
                });
            }
        });
    });

    // Sort and take top 15 industries
    const sortedIndustries = Object.entries(industryTotals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15);

    if (sortedIndustries.length === 0) {
        charts.industry.clear();
        chartDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No industry data available for selected countries and factor group.</div>';
        return;
    }

    const option = {
        backgroundColor: 'transparent',
        animationDuration: 1500,
        tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            formatter: params => {
                const p = params[0];
                return `<strong>${p.name}</strong><br/>${formatNumber(p.value)}`;
            }
        },
        grid: {
            left: '25%',
            right: '10%',
            top: '3%',
            bottom: '3%',
            containLabel: false
        },
        xAxis: {
            type: 'value',
            axisLabel: { 
                formatter: value => formatNumber(value),
                color: '#666',
                fontSize: 11
            },
            splitLine: { lineStyle: { color: '#f0f0f0' } }
        },
        yAxis: {
            type: 'category',
            data: sortedIndustries.map(([name]) => name),
            axisLabel: {
                fontSize: 11,
                interval: 0,
                overflow: 'truncate',
                width: 150,
                color: '#666'
            },
            axisLine: { lineStyle: { color: '#ddd' } }
        },
        series: [{
            type: 'bar',
            data: sortedIndustries.map(([name, value]) => ({
                value: value,
                itemStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                        { offset: 0, color: '#667eea' },
                        { offset: 1, color: '#764ba2' }
                    ])
                }
            })),
            barWidth: '60%',
            emphasis: {
                itemStyle: {
                    shadowBlur: 15,
                    shadowColor: 'rgba(0,0,0,0.3)'
                }
            }
        }]
    };

    charts.industry.setOption(option, true);
}
```

**Features:**
- ‚úÖ Horizontal bars for long industry names
- ‚úÖ Top 15 industries only (prevents clutter)
- ‚úÖ Purple gradient colors
- ‚úÖ Text overflow handling
- ‚úÖ Aggregates across all trade flows

**Common Issue:** Empty chart when data not properly aggregated  
**Solution:** Always verify `industryLookup` is populated before running aggregation

---

*This is Part 1 of the CLAUDE.md file. The file continues with remaining chart components, UI patterns, data processing functions, and integration guidelines.*

---

## File Contents Summary

This CLAUDE.md file contains:

1. ‚úÖ **Data Structure** - Complete file organization and schema
2. ‚úÖ **Core Configuration** - Countries, factors, global state
3. ‚è≥ **Chart Components** (3 of 8 completed):
   - Country Comparison Bar Chart
   - Trade Flow Breakdown
   - Industry Breakdown
4. ‚è≥ **Remaining sections to add:**
   - Dual Pie Charts
   - Impact Intensity Gauges
   - Environmental Timeline/Journey
   - Flow-Rings Visualization
   - Chord-Sankey Hybrid
   - UI/UX Patterns
   - Data Processing Functions
   - Performance & Debugging
   - Integration Guidelines

**File size so far:** ~50KB (target: 150-200KB for complete documentation)

### 4. Dual Pie Charts - Trade Flow Split

**Purpose:** Separate domestic+exports and domestic+imports comparisons side-by-side

**Dependencies:** ECharts

**HTML:**
```html
<div class="chart-section">
    <div class="chart-header">
        <h3>üìä Trade Flow Distribution</h3>
        <select id="pie-country-select" class="factor-btn" onchange="updatePieCharts()">
            <option value="">Select Country</option>
            <!-- Populated dynamically -->
        </select>
    </div>
    <div class="dual-pie-container">
        <div class="pie-chart-wrapper">
            <h4>Domestic vs Exports</h4>
            <div id="chart-pie-exports" style="width: 100%; height: 350px;"></div>
        </div>
        <div class="pie-chart-wrapper">
            <h4>Domestic vs Imports</h4>
            <div id="chart-pie-imports" style="width: 100%; height: 350px;"></div>
        </div>
    </div>
</div>
```

**CSS:**
```css
.dual-pie-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 15px;
}

@media (max-width: 768px) {
    .dual-pie-container {
        grid-template-columns: 1fr;
    }
}

.pie-chart-wrapper {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.pie-chart-wrapper h4 {
    text-align: center;
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #64748b;
    font-weight: 600;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

#pie-country-select {
    min-width: 200px;
    padding: 10px 15px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    background: white;
    cursor: pointer;
    font-size: 14px;
}
```

**JavaScript:**
```javascript
function updatePieCharts() {
    updatePieChartExports();
    updatePieChartImports();
}

function populatePieCountrySelector() {
    const selector = document.getElementById('pie-country-select');
    if (!selector) return;
    
    selector.innerHTML = '<option value="">Select Country</option>';
    
    Array.from(selectedCountries).forEach(code => {
        if (COUNTRIES[code]) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = COUNTRIES[code].name;
            selector.appendChild(option);
        }
    });
    
    // Auto-select first country
    if (selectedCountries.size > 0) {
        selector.value = Array.from(selectedCountries)[0];
        updatePieCharts();
    }
}

function updatePieChartExports() {
    const chartDiv = document.getElementById('chart-pie-exports');
    if (!chartDiv) return;
    
    if (!charts.pieExports) {
        charts.pieExports = echarts.init(chartDiv);
    }

    const selector = document.getElementById('pie-country-select');
    const selectedCode = selector ? selector.value : '';
    
    if (!selectedCode || !COUNTRIES[selectedCode]) {
        charts.pieExports.clear();
        return;
    }

    const domestic = calculateTotalByFlow(selectedCode, currentFactorGroup, 'domestic');
    const exports = calculateTotalByFlow(selectedCode, currentFactorGroup, 'exports');
    
    const total = domestic + exports;
    const domesticPct = total > 0 ? ((domestic / total) * 100).toFixed(1) : 0;
    const exportsPct = total > 0 ? ((exports / total) * 100).toFixed(1) : 0;

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}<br/>({d}%)'
        },
        legend: {
            orient: 'horizontal',
            bottom: 0,
            left: 'center',
            textStyle: { fontSize: 12 }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            center: ['50%', '45%'],
            avoidLabelOverlap: true,
            data: [
                { 
                    value: domestic, 
                    name: 'Domestic',
                    itemStyle: { color: '#3b82f6' }
                },
                { 
                    value: exports, 
                    name: 'Exports',
                    itemStyle: { color: '#10b981' }
                }
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: true,
                formatter: '{b}\n{d}%',
                fontSize: 12,
                fontWeight: 500
            }
        }]
    };

    charts.pieExports.setOption(option, true);
}

function updatePieChartImports() {
    const chartDiv = document.getElementById('chart-pie-imports');
    if (!chartDiv) return;
    
    if (!charts.pieImports) {
        charts.pieImports = echarts.init(chartDiv);
    }

    const selector = document.getElementById('pie-country-select');
    const selectedCode = selector ? selector.value : '';
    
    if (!selectedCode || !COUNTRIES[selectedCode]) {
        charts.pieImports.clear();
        return;
    }

    const domestic = calculateTotalByFlow(selectedCode, currentFactorGroup, 'domestic');
    const imports = calculateTotalByFlow(selectedCode, currentFactorGroup, 'imports');
    
    const total = domestic + imports;

    const option = {
        backgroundColor: 'transparent',
        tooltip: {
            trigger: 'item',
            formatter: '{b}: {c}<br/>({d}%)'
        },
        legend: {
            orient: 'horizontal',
            bottom: 0,
            left: 'center',
            textStyle: { fontSize: 12 }
        },
        series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            center: ['50%', '45%'],
            avoidLabelOverlap: true,
            data: [
                { 
                    value: domestic, 
                    name: 'Domestic',
                    itemStyle: { color: '#3b82f6' }
                },
                { 
                    value: imports, 
                    name: 'Imports',
                    itemStyle: { color: '#f59e0b' }
                }
            ],
            emphasis: {
                itemStyle: {
                    shadowBlur: 10,
                    shadowOffsetX: 0,
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
            },
            label: {
                show: true,
                formatter: '{b}\n{d}%',
                fontSize: 12,
                fontWeight: 500
            }
        }]
    };

    charts.pieImports.setOption(option, true);
}
```

**Features:**
- ‚úÖ Side-by-side comparison
- ‚úÖ Country selector outside charts (prevents overlap)
- ‚úÖ Donut style pie charts
- ‚úÖ Percentage labels on slices
- ‚úÖ Consistent color scheme
- ‚úÖ Legend below charts (not covering data)
- ‚úÖ Responsive grid layout

**Why Two Charts:** Prevents legend and selector from covering chart area, improves readability when comparing trade patterns.

---

### 5. Impact Intensity Gauge Meters

**Purpose:** Visual "speedometer" showing relative impact level per country

**Dependencies:** ECharts

**HTML:**
```html
<div class="gauge-section">
    <h3>‚ö° Impact Intensity Meters</h3>
    <p class="section-subtitle">Relative environmental impact intensity by country</p>
    <div class="gauge-grid" id="gauge-container">
        <!-- Gauges populated dynamically -->
    </div>
</div>
```

**CSS:**
```css
.gauge-section {
    margin: 40px 0;
    padding: 30px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: 16px;
}

.gauge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.gauge-item {
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-height: 240px;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}

.gauge-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.gauge-title {
    text-align: center;
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 14px;
    color: #334155;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.gauge-chart {
    flex: 1;
    width: 100%;
    min-height: 180px;
}
```

**JavaScript:**
```javascript
function updateGaugeChart() {
    const container = document.getElementById('gauge-container');
    if (!container) return;
    
    // Clear existing gauges
    container.innerHTML = '';
    Object.keys(charts).forEach(key => {
        if (key.startsWith('gauge-')) {
            charts[key].dispose();
            delete charts[key];
        }
    });

    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) return;
    
    // Find max value for normalization (0-100 scale)
    const allValues = countries.map(code => calculateTotalForCountry(code, currentFactorGroup));
    const maxValue = Math.max(...allValues);
    
    countries.forEach(code => {
        const country = COUNTRIES[code];
        const value = calculateTotalForCountry(code, currentFactorGroup);
        const normalized = maxValue > 0 ? (value / maxValue) * 100 : 0;
        
        // Create gauge container
        const gaugeItem = document.createElement('div');
        gaugeItem.className = 'gauge-item';
        gaugeItem.innerHTML = `
            <div class="gauge-title">
                <span class="fi fi-${code === 'WM' ? 'un' : code.toLowerCase()}"></span>
                ${country.name}
            </div>
            <div class="gauge-chart" id="gauge-${code}"></div>
        `;
        container.appendChild(gaugeItem);
        
        // Initialize gauge chart
        const chartDiv = document.getElementById(`gauge-${code}`);
        charts[`gauge-${code}`] = echarts.init(chartDiv);
        
        const option = {
            series: [{
                type: 'gauge',
                min: 0,
                max: 100,
                splitNumber: 4,
                radius: '85%',
                center: ['50%', '60%'],
                startAngle: 200,
                endAngle: -20,
                axisLine: {
                    lineStyle: {
                        width: 20,
                        color: [
                            [0.25, '#10b981'],  // Green (Low)
                            [0.50, '#3b82f6'],  // Blue (Moderate)
                            [0.75, '#f59e0b'],  // Orange (High)
                            [1.00, '#ef4444']   // Red (Critical)
                        ]
                    }
                },
                pointer: {
                    length: '60%',
                    width: 6,
                    itemStyle: {
                        color: '#334155',
                        shadowBlur: 5,
                        shadowColor: 'rgba(0,0,0,0.3)'
                    }
                },
                axisTick: {
                    distance: -20,
                    length: 8,
                    lineStyle: {
                        color: '#fff',
                        width: 2
                    }
                },
                splitLine: {
                    distance: -25,
                    length: 15,
                    lineStyle: {
                        color: '#fff',
                        width: 3
                    }
                },
                axisLabel: {
                    distance: -35,
                    color: '#64748b',
                    fontSize: 10,
                    formatter: value => value
                },
                detail: {
                    valueAnimation: true,
                    formatter: '{value}',
                    color: country.color,
                    fontSize: 18,
                    fontWeight: 'bold',
                    offsetCenter: [0, '85%']
                },
                title: {
                    offsetCenter: [0, '100%'],
                    fontSize: 11,
                    color: '#94a3b8'
                },
                data: [{ 
                    value: normalized.toFixed(1),
                    name: 'Intensity'
                }]
            }]
        };
        
        charts[`gauge-${code}`].setOption(option);
    });
    
    // CRITICAL FIX: Force resize after DOM settles
    setTimeout(() => {
        Object.keys(charts).forEach(key => {
            if (key.startsWith('gauge-') && charts[key]) {
                charts[key].resize();
            }
        });
    }, 100);
}
```

**Color Zones:**
- üü¢ **0-25%:** Green (Low impact)
- üîµ **25-50%:** Blue (Moderate impact)
- üü† **50-75%:** Orange (High impact)
- üî¥ **75-100%:** Red (Critical impact)

**Features:**
- ‚úÖ Normalized 0-100 scale (relative to max)
- ‚úÖ Color-coded zones
- ‚úÖ Animated needle
- ‚úÖ Country-specific colors in value
- ‚úÖ Grid layout (auto-fit)
- ‚úÖ Hover elevation effect

**Known Issue:** Gauges may overflow container on initial load at 100% zoom  
**Solution:** Implemented `setTimeout` resize fix after DOM settles (see code above)

---

### 6. Environmental Impact Timeline/Journey (Zig-Zag)

**Purpose:** Narrative flow showing country impacts with contextual insights

**Dependencies:** None (pure CSS + HTML)

**HTML:**
```html
<div class="storyline-section">
    <h2>üåç Environmental Impact Journey</h2>
    <p class="section-subtitle">Explore the environmental footprint across trade flows</p>
    <div class="storyline-container" id="storyline-container">
        <!-- Timeline populated dynamically -->
    </div>
</div>
```

**CSS:**
```css
.storyline-section {
    margin: 60px 0;
    padding: 40px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
}

.storyline-section h2 {
    margin: 0 0 10px 0;
    color: white;
    font-size: 32px;
}

.section-subtitle {
    margin: 0 0 40px 0;
    opacity: 0.9;
    font-size: 16px;
}

.storyline-container {
    position: relative;
    padding: 40px 0;
}

.storyline-timeline {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.8), rgba(255,255,255,0.3));
    z-index: 1;
}

.storyline-item {
    display: grid;
    grid-template-columns: 1fr 80px 1fr;
    gap: 30px;
    align-items: center;
    margin-bottom: 60px;
    position: relative;
    z-index: 2;
}

.storyline-item:last-child {
    margin-bottom: 0;
}

/* Zig-zag pattern */
.storyline-item.left .journey-card {
    grid-column: 1;
}

.storyline-item.left .journey-insights {
    grid-column: 3;
}

.storyline-item.right .journey-card {
    grid-column: 3;
}

.storyline-item.right .journey-insights {
    grid-column: 1;
}

.storyline-node {
    grid-column: 2;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    border: 4px solid rgba(255,255,255,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 22px;
    color: #667eea;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 3;
}

.journey-card {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
    color: #334155;
}

.journey-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 32px rgba(0,0,0,0.25);
}

.journey-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.journey-flag {
    font-size: 32px;
}

.journey-title {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
    color: #1e293b;
}

.journey-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 20px;
}

.journey-stat {
    background: #f8fafc;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
}

.stat-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.stat-label {
    display: block;
    font-size: 12px;
    color: #64748b;
    margin-bottom: 4px;
    font-weight: 500;
}

.stat-value {
    display: block;
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
}

.comparison-total {
    border-top: 2px solid #e2e8f0;
    padding-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comparison-total-label {
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
}

.comparison-total-value {
    font-size: 24px;
    font-weight: 700;
}

.journey-insights {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 25px;
    border: 2px solid rgba(255,255,255,0.3);
}

.journey-insights h4 {
    margin: 0 0 15px 0;
    color: white;
    font-size: 18px;
    font-weight: 600;
}

.journey-insights ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.journey-insights li {
    padding: 10px 0 10px 28px;
    position: relative;
    color: rgba(255,255,255,0.95);
    font-size: 14px;
    line-height: 1.6;
}

.journey-insights li:before {
    content: "‚ñ∏";
    position: absolute;
    left: 8px;
    color: white;
    font-weight: bold;
    font-size: 16px;
}

/* Responsive */
@media (max-width: 768px) {
    .storyline-item {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .storyline-item .journey-card,
    .storyline-item .journey-insights {
        grid-column: 1 !important;
    }
    
    .storyline-node {
        display: none;
    }
    
    .storyline-timeline {
        display: none;
    }
}
```

**JavaScript:**
```javascript
function updateStoryline() {
    const container = document.getElementById('storyline-container');
    if (!container) return;
    
    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.8);">Select countries to see their environmental impact journey</div>';
        return;
    }
    
    // Define insights for each country
    const countryInsights = {
        'US': [
            'Largest per-capita CO‚ÇÇ emissions among developed nations',
            'Energy sector dominates environmental footprint across all flows',
            'Strong domestic production with significant export activity'
        ],
        'CN': [
            'Global manufacturing hub with high material consumption',
            'Rapid renewable energy expansion offsetting fossil fuel growth',
            'Major exporter of manufactured goods with complex supply chains'
        ],
        'GB': [
            'Transition to service-based economy reduces industrial impact',
            'Lower land use compared to manufacturing-focused economies',
            'Significant import dependency for materials and energy'
        ],
        'DE': [
            'Advanced manufacturing with world-leading energy efficiency',
            'Pioneer in renewable energy integration and circular economy',
            'Strong export-oriented industrial base in automotive and machinery'
        ],
        'IN': [
            'Rapidly growing industrial sector with rising emissions trajectory',
            'Large agricultural land use footprint supporting 1.4B population',
            'Increasing domestic consumption driving environmental pressures'
        ],
        'JP': [
            'Technology-focused economy with highly efficient processes',
            'Limited domestic resources drive high import dependency',
            'Advanced waste management and material recycling systems'
        ],
        'FR': [
            'Nuclear energy provides low-carbon electricity foundation',
            'Strong agricultural sector with significant land use',
            'Balanced trade flows across domestic, import, and export'
        ],
        'IT': [
            'Manufacturing excellence in fashion, automotive, and machinery',
            'Mediterranean agriculture with water resource challenges',
            'Energy import dependency drives transition to renewables'
        ],
        'BR': [
            'Vast natural resources with agriculture and mining dominance',
            'Amazon deforestation concerns linked to land use expansion',
            'Growing domestic market balancing export commodity focus'
        ],
        'CA': [
            'Resource extraction economy with energy export strength',
            'Cold climate increases heating energy demands',
            'Vast land area with relatively low population density'
        ],
        'RU': [
            'Major fossil fuel exporter dominating energy trade flows',
            'Large land mass with significant forest carbon sequestration',
            'Industrial base requires modernization for efficiency gains'
        ],
        'KR': [
            'High-tech manufacturing with electronics and automotive focus',
            'Dense urban population concentrating environmental pressures',
            'Heavy reliance on imported energy and raw materials'
        ],
        'AU': [
            'Mining and agriculture drive exports and environmental footprint',
            'Per-capita emissions among highest globally',
            'Renewable energy transition accelerating in recent years'
        ],
        'WM': [
            'Oil and gas extraction defines regional economy and impacts',
            'Water scarcity challenges across Middle Eastern nations',
            'Diversification efforts reducing petroleum dependency'
        ],
        'default': [
            'Mixed economic structure across industrial and service sectors',
            'Environmental impacts vary significantly by trade flow types',
            'Balancing economic growth with sustainability commitments'
        ]
    };
    
    let html = '<div class="storyline-timeline"></div>';
    
    countries.forEach((code, index) => {
        const country = COUNTRIES[code];
        const total = calculateTotalForCountry(code, currentFactorGroup);
        const domestic = calculateTotalByFlow(code, currentFactorGroup, 'domestic');
        const exports = calculateTotalByFlow(code, currentFactorGroup, 'exports');
        const imports = calculateTotalByFlow(code, currentFactorGroup, 'imports');
        
        const alignment = index % 2 === 0 ? 'left' : 'right';
        const insights = countryInsights[code] || countryInsights['default'];
        
        html += `
            <div class="storyline-item ${alignment}">
                <div class="journey-card">
                    <div class="journey-header">
                        <span class="journey-flag"><span class="fi fi-${code.toLowerCase()}"></span></span>
                        <h3 class="journey-title">${country.name}</h3>
                    </div>
                    <div class="journey-stats">
                        <div class="journey-stat">
                            <div class="stat-icon">üè≠</div>
                            <span class="stat-label">Domestic</span>
                            <span class="stat-value">${formatNumber(domestic)}</span>
                        </div>
                        <div class="journey-stat">
                            <div class="stat-icon">üì§</div>
                            <span class="stat-label">Exports</span>
                            <span class="stat-value">${formatNumber(exports)}</span>
                        </div>
                        <div class="journey-stat">
                            <div class="stat-icon">üì•</div>
                            <span class="stat-label">Imports</span>
                            <span class="stat-value">${formatNumber(imports)}</span>
                        </div>
                    </div>
                    <div class="comparison-total">
                        <div class="comparison-total-label">Total Impact</div>
                        <div class="comparison-total-value" style="color: ${country.color}">
                            ${formatNumber(total)}
                        </div>
                    </div>
                </div>
                
                <div class="storyline-node">${index + 1}</div>
                
                <div class="journey-insights">
                    <h4>üí° Key Insights</h4>
                    <ul>
                        ${insights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}
```

**Features:**
- ‚úÖ Zig-zag pattern alternates cards left/right
- ‚úÖ Numbered timeline nodes connect sections
- ‚úÖ Contextual insights on opposite side of cards
- ‚úÖ Smooth hover animations
- ‚úÖ Country-specific insights database
- ‚úÖ Gradient background with glassmorphism
- ‚úÖ Fully responsive (stacks on mobile)

**Design Pattern:**
```
Card (Left) ‚Üê ‚Üí Timeline Node ‚Üê ‚Üí Insights (Right)
Insights (Left) ‚Üê ‚Üí Timeline Node ‚Üê ‚Üí Card (Right)
```

---

### 7. Flow-Rings Visualization (D3.js)

**Purpose:** Concentric rings showing trade volumes and environmental impacts across categories

**Dependencies:** D3.js v7

**CDN Links:**
```html
<script src="https://d3js.org/d3.v7.min.js"></script>
```

**HTML:**
```html
<div class="flow-rings-section">
    <h2>üîÑ Flow-Rings Visualization</h2>
    <p class="section-subtitle">Concentric trade flows with environmental impact overlay</p>
    <div class="flow-rings-controls">
        <button onclick="exportFlowSVG()" class="export-btn">
            <span>üì•</span> Export SVG
        </button>
        <button onclick="exportFlowPNG()" class="export-btn">
            <span>üì∏</span> Export PNG
        </button>
        <button onclick="resetFlowRings()" class="export-btn">
            <span>üîÑ</span> Reset View
        </button>
    </div>
    <div id="flow-rings-container" style="width: 100%; height: 800px; background: #f8fafc; border-radius: 12px;"></div>
</div>
```

**CSS:**
```css
.flow-rings-section {
    margin: 60px 0;
    padding: 40px 30px;
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.flow-rings-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.export-btn {
    padding: 10px 18px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.export-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.export-btn:active {
    transform: translateY(0);
}

#flow-rings-container {
    position: relative;
    overflow: hidden;
}

.flow-tooltip {
    position: absolute;
    background: rgba(30, 30, 30, 0.95);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    pointer-events: none;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    max-width: 250px;
}

.flow-tooltip strong {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.3);
    padding-bottom: 4px;
}
```

**JavaScript:**
```javascript
// Initialize Flow-Rings visualization
function initFlowRingsSimple() {
    const container = d3.select('#flow-rings-container');
    container.selectAll('*').remove();
    
    const width = container.node().getBoundingClientRect().width;
    const height = 800;
    const centerX = width / 2;
    const centerY = height / 2;
    const maxRadius = Math.min(width, height) / 2 - 60;
    
    const svg = container
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('id', 'flow-rings-svg')
        .style('background', '#f8fafc');
    
    const mainGroup = svg.append('g')
        .attr('transform', `translate(${centerX}, ${centerY})`);
    
    // Draw concentric rings for trade categories
    const categories = ['Manufacturing', 'Services', 'Agriculture', 'Energy', 'Resources'];
    const numRings = categories.length;
    const ringGap = maxRadius / (numRings + 0.5);
    
    // Add title
    svg.append('text')
        .attr('x', centerX)
        .attr('y', 30)
        .attr('text-anchor', 'middle')
        .attr('font-size', '18px')
        .attr('font-weight', 'bold')
        .attr('fill', '#334155')
        .text('Trade Flow Distribution by Category');
    
    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) {
        svg.append('text')
            .attr('x', centerX)
            .attr('y', centerY)
            .attr('text-anchor', 'middle')
            .attr('font-size', '16px')
            .attr('fill', '#94a3b8')
            .text('Select countries to visualize trade flows');
        return;
    }
    
    // Draw rings
    categories.forEach((category, i) => {
        const radius = ringGap * (i + 1);
        
        // Ring circle
        mainGroup.append('circle')
            .attr('r', radius)
            .attr('fill', 'none')
            .attr('stroke', '#cbd5e1')
            .attr('stroke-width', 2)
            .attr('opacity', 0.6);
        
        // Ring label
        mainGroup.append('text')
            .attr('x', 0)
            .attr('y', -radius - 12)
            .attr('text-anchor', 'middle')
            .attr('font-size', '13px')
            .attr('font-weight', '600')
            .attr('fill', '#64748b')
            .text(category);
    });
    
    // Add country arcs on rings
    const angleStep = (2 * Math.PI) / Math.max(countries.length, 4);
    
    countries.forEach((code, idx) => {
        const country = COUNTRIES[code];
        const angle = angleStep * idx - Math.PI / 2; // Start at top
        const arcLength = angleStep * 0.75; // Leave gap between arcs
        
        categories.forEach((category, ringIdx) => {
            const radius = ringGap * (ringIdx + 1);
            const value = calculateTotalForCountry(code, currentFactorGroup);
            const normalized = value / 1000000; // Normalize for visual sizing
            const arcWidth = Math.min(20, Math.max(10, normalized * 2));
            
            // Draw arc for this country on this ring
            const arc = d3.arc()
                .innerRadius(radius - arcWidth / 2)
                .outerRadius(radius + arcWidth / 2)
                .startAngle(angle - arcLength / 2)
                .endAngle(angle + arcLength / 2)
                .cornerRadius(3);
            
            const arcPath = mainGroup.append('path')
                .attr('d', arc)
                .attr('fill', country.color)
                .attr('opacity', 0.75)
                .attr('stroke', '#fff')
                .attr('stroke-width', 1.5)
                .style('cursor', 'pointer')
                .on('mouseover', function(event) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 1)
                        .attr('stroke-width', 2.5);
                    
                    showFlowTooltip(code, category, value, event);
                })
                .on('mouseout', function() {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr('opacity', 0.75)
                        .attr('stroke-width', 1.5);
                    
                    hideFlowTooltip();
                });
        });
        
        // Add country label at the outer edge
        const labelRadius = maxRadius + 30;
        const labelAngle = angle;
        const labelX = Math.cos(labelAngle) * labelRadius;
        const labelY = Math.sin(labelAngle) * labelRadius;
        
        mainGroup.append('text')
            .attr('x', labelX)
            .attr('y', labelY)
            .attr('text-anchor', 'middle')
            .attr('font-size', '12px')
            .attr('font-weight', '600')
            .attr('fill', country.color)
            .text(code);
    });
}

// Update visualization based on factor selection
function syncFlowRingsWithFactor() {
    if (typeof initFlowRingsSimple === 'function') {
        initFlowRingsSimple();
    }
}

// Tooltip functions
function showFlowTooltip(countryCode, category, value, event) {
    hideFlowTooltip();
    
    const country = COUNTRIES[countryCode];
    const tooltip = d3.select('body')
        .append('div')
        .attr('class', 'flow-tooltip');
    
    tooltip.html(`
        <strong><span class="fi fi-${countryCode.toLowerCase()}"></span> ${country.name}</strong>
        <div style="margin-top: 8px;">
            <div>Category: <strong>${category}</strong></div>
            <div>Impact: <strong>${formatNumber(value)}</strong></div>
            <div>Factor: <strong>${currentFactorGroup}</strong></div>
        </div>
    `)
    .style('left', (event.pageX + 15) + 'px')
    .style('top', (event.pageY - 40) + 'px')
    .style('opacity', 0)
    .transition()
    .duration(200)
    .style('opacity', 1);
}

function hideFlowTooltip() {
    d3.selectAll('.flow-tooltip')
        .transition()
        .duration(200)
        .style('opacity', 0)
        .remove();
}

// Export functions
function exportFlowSVG() {
    const svgElement = document.getElementById('flow-rings-svg');
    if (!svgElement) {
        alert('No visualization to export');
        return;
    }
    
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgElement);
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `flow-rings-${currentFactorGroup}-${Date.now()}.svg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function exportFlowPNG() {
    const svgElement = document.getElementById('flow-rings-svg');
    if (!svgElement) {
        alert('No visualization to export');
        return;
    }
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgElement);
    
    canvas.width = svgElement.width.baseVal.value;
    canvas.height = svgElement.height.baseVal.value;
    
    img.onload = function() {
        ctx.fillStyle = '#f8fafc';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `flow-rings-${currentFactorGroup}-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    };
    
    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const svgUrl = URL.createObjectURL(svgBlob);
    img.src = svgUrl;
}

function resetFlowRings() {
    initFlowRingsSimple();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('flow-rings-container')) {
        initFlowRingsSimple();
    }
});
```

**Features:**
- ‚úÖ Concentric rings for different trade categories
- ‚úÖ Country arcs sized by trade volume
- ‚úÖ Color-coded by country
- ‚úÖ Interactive hover tooltips
- ‚úÖ SVG and PNG export with timestamp
- ‚úÖ Syncs with global country and factor selection
- ‚úÖ Clean, modern design with subtle animations
- ‚úÖ Responsive sizing

**Implementation Notes:**
- Must initialize D3.js before calling
- Syncs automatically with factor changes
- Empty state message when no countries selected
- Tooltips show country flag, category, impact value

---

### 8. Chord-Sankey Hybrid for Trade Flows

**Purpose:** Visualize bilateral trade flows with environmental impact overlay using chord diagram

**Dependencies:** D3.js v7

**HTML:**
```html
<div class="sankey-section">
    <h2>üîÄ Trade Flow Network</h2>
    <p class="section-subtitle">Dynamic pathways of environmental impact between nations</p>
    <div class="sankey-controls">
        <button onclick="exportSankeyPNG()" class="export-btn">
            <span>üì∏</span> Export PNG
        </button>
        <button onclick="exportSankeySVG()" class="export-btn">
            <span>üì•</span> Export SVG
        </button>
        <button onclick="resetSankey()" class="export-btn">
            <span>üîÑ</span> Reset
        </button>
    </div>
    <div id="chord-sankey-container" style="width: 100%; height: 700px;"></div>
</div>
```

**CSS:**
```css
.sankey-section {
    margin: 60px 0;
    padding: 40px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 20px;
    color: white;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.sankey-section h2 {
    margin: 0 0 10px 0;
    color: white;
    font-size: 32px;
}

.sankey-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.sankey-controls .export-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
}

.sankey-controls .export-btn:hover {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
}

#chord-sankey-container {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}
```

**JavaScript:**
```javascript
function updateSankeyChart() {
    const container = d3.select('#chord-sankey-container');
    container.selectAll('*').remove();
    
    const width = container.node().getBoundingClientRect().width;
    const height = 700;
    const outerRadius = Math.min(width, height) * 0.38;
    const innerRadius = outerRadius - 80;
    
    const svg = container
        .append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('id', 'sankey-svg')
        .append('g')
        .attr('transform', `translate(${width / 2}, ${height / 2})`);
    
    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length < 2) {
        svg.append('text')
            .attr('text-anchor', 'middle')
            .attr('font-size', '16px')
            .attr('fill', '#94a3b8')
            .text('Select at least 2 countries to visualize trade flows');
        return;
    }
    
    // Calculate trade flows between selected countries
    const flowData = calculateTradeFlows(countries);
    
    // Create chord layout
    const chord = d3.chord()
        .padAngle(0.05)
        .sortSubgroups(d3.descending);
    
    const arc = d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(outerRadius);
    
    const ribbon = d3.ribbon()
        .radius(innerRadius);
    
    const chords = chord(flowData.matrix);
    
    // Color scale based on impact
    const maxImpact = d3.max(flowData.impacts);
    const colorScale = d3.scaleSequential(d3.interpolateViridis)
        .domain([0, maxImpact]);
    
    // Draw country arcs
    const group = svg.append('g')
        .attr('class', 'arcs')
        .selectAll('g')
        .data(chords.groups)
        .join('g');
    
    group.append('path')
        .attr('fill', (d, i) => COUNTRIES[countries[i]].color)
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .attr('d', arc)
        .on('mouseover', function(event, d) {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('stroke-width', 4);
        })
        .on('mouseout', function() {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('stroke-width', 2);
        });
    
    // Add country labels
    group.append('text')
        .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
        .attr('dy', '.35em')
        .attr('transform', d => `
            rotate(${(d.angle * 180 / Math.PI - 90)})
            translate(${outerRadius + 15})
            ${d.angle > Math.PI ? 'rotate(180)' : ''}
        `)
        .attr('text-anchor', d => d.angle > Math.PI ? 'end' : 'start')
        .text((d, i) => COUNTRIES[countries[i]].name)
        .style('font-size', '13px')
        .style('font-weight', '600')
        .style('fill', '#334155');
    
    // Draw flow ribbons
    const ribbons = svg.append('g')
        .attr('class', 'ribbons')
        .attr('fill-opacity', 0.6)
        .selectAll('path')
        .data(chords)
        .join('path')
        .attr('d', ribbon)
        .attr('fill', d => {
            const impact = flowData.matrix[d.source.index][d.target.index];
            return colorScale(impact);
        })
        .attr('stroke', d => {
            const impact = flowData.matrix[d.source.index][d.target.index];
            return colorScale(impact);
        })
        .attr('stroke-width', 1)
        .style('mix-blend-mode', 'multiply')
        .on('mouseover', function(event, d) {
            const sourceCode = countries[d.source.index];
            const targetCode = countries[d.target.index];
            const value = flowData.matrix[d.source.index][d.target.index];
            
            d3.select(this)
                .transition()
                .duration(200)
                .attr('fill-opacity', 0.9)
                .attr('stroke-width', 2);
            
            showFlowTooltip(sourceCode, targetCode, value, event);
        })
        .on('mouseout', function() {
            d3.select(this)
                .transition()
                .duration(200)
                .attr('fill-opacity', 0.6)
                .attr('stroke-width', 1);
            
            hideFlowTooltip();
        });
    
    // Add animated flow particles
    addFlowParticles(svg, chords, ribbon, countries, flowData);
    
    // Add legend
    addChordLegend(svg, colorScale, maxImpact, outerRadius);
}

function calculateTradeFlows(countries) {
    const n = countries.length;
    const matrix = Array(n).fill(0).map(() => Array(n).fill(0));
    const impacts = [];
    
    countries.forEach((sourceCode, i) => {
        countries.forEach((targetCode, j) => {
            if (i === j) {
                matrix[i][j] = 0;
                return;
            }
            
            // Calculate flow from source to target
            let flow = 0;
            
            if (tradeData[sourceCode] && tradeData[sourceCode].exports) {
                const exports = tradeData[sourceCode].exports.trade || [];
                const exportFactors = tradeData[sourceCode].exports.trade_factor || [];
                
                exports.forEach(trade => {
                    if (trade.destination === targetCode) {
                        exportFactors
                            .filter(f => f.trade_id === trade.trade_id)
                            .forEach(factorRow => {
                                const factor = factorLookup[factorRow.factor_id];
                                if (factor && getFactorGroup(factor.extension) === currentFactorGroup) {
                                    flow += parseFloat(factorRow.impact_value) || 0;
                                }
                            });
                    }
                });
            }
            
            matrix[i][j] = flow;
            impacts.push(flow);
        });
    });
    
    return { matrix, impacts };
}

function addFlowParticles(g, chords, ribbon, countries, flowData) {
    chords.forEach(chord => {
        if (chord.source.index === chord.target.index) return;
        
        const path = ribbon(chord);
        const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        pathElement.setAttribute('d', path);
        const length = pathElement.getTotalLength();
        
        // Create 2 particles per flow
        for (let i = 0; i < 2; i++) {
            const particle = g.append('circle')
                .attr('r', 4)
                .attr('fill', COUNTRIES[countries[chord.source.index]].color)
                .attr('opacity', 0)
                .style('filter', 'drop-shadow(0 0 3px rgba(255,255,255,0.8))');
            
            function animateParticle() {
                const duration = 4000 + Math.random() * 2000;
                const delay = i * 2000;
                
                particle
                    .transition()
                    .delay(delay)
                    .duration(duration)
                    .ease(d3.easeLinear)
                    .attrTween('transform', () => {
                        return t => {
                            const point = pathElement.getPointAtLength(t * length);
                            return `translate(${point.x}, ${point.y})`;
                        };
                    })
                    .attrTween('opacity', () => {
                        return t => {
                            if (t < 0.1) return t * 10;
                            if (t > 0.9) return (1 - t) * 10;
                            return 0.8;
                        };
                    })
                    .on('end', animateParticle);
            }
            
            animateParticle();
        }
    });
}

function addChordLegend(svg, colorScale, maxImpact, outerRadius) {
    const legendWidth = 200;
    const legendHeight = 15;
    const legendX = -legendWidth / 2;
    const legendY = outerRadius + 60;
    
    const legendGroup = svg.append('g')
        .attr('class', 'legend')
        .attr('transform', `translate(${legendX}, ${legendY})`);
    
    // Create gradient
    const defs = svg.append('defs');
    const gradient = defs.append('linearGradient')
        .attr('id', 'legend-gradient')
        .attr('x1', '0%')
        .attr('x2', '100%');
    
    const steps = 10;
    for (let i = 0; i <= steps; i++) {
        gradient.append('stop')
            .attr('offset', `${(i / steps) * 100}%`)
            .attr('stop-color', colorScale((i / steps) * maxImpact));
    }
    
    // Draw legend bar
    legendGroup.append('rect')
        .attr('width', legendWidth)
        .attr('height', legendHeight)
        .style('fill', 'url(#legend-gradient)')
        .attr('rx', 4);
    
    // Add labels
    legendGroup.append('text')
        .attr('x', 0)
        .attr('y', legendHeight + 18)
        .attr('text-anchor', 'start')
        .attr('font-size', '11px')
        .attr('fill', '#64748b')
        .text('Low Impact');
    
    legendGroup.append('text')
        .attr('x', legendWidth)
        .attr('y', legendHeight + 18)
        .attr('text-anchor', 'end')
        .attr('font-size', '11px')
        .attr('fill', '#64748b')
        .text('High Impact');
}

function exportSankeySVG() {
    const svgElement = document.getElementById('sankey-svg');
    if (!svgElement) return;
    
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svgElement.parentElement);
    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `trade-flow-network-${currentFactorGroup}-${Date.now()}.svg`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function exportSankeyPNG() {
    const svgElement = document.getElementById('sankey-svg');
    if (!svgElement) return;
    
    const parentSvg = svgElement.parentElement;
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(parentSvg);
    
    canvas.width = parentSvg.width.baseVal.value;
    canvas.height = parentSvg.height.baseVal.value;
    
    img.onload = function() {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);
        
        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trade-flow-network-${currentFactorGroup}-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });
    };
    
    const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
    const svgUrl = URL.createObjectURL(svgBlob);
    img.src = svgUrl;
}

function resetSankey() {
    updateSankeyChart();
}
```

**Features:**
- ‚úÖ Chord diagram for directional flows (A ‚Üí B)
- ‚úÖ Ribbon thickness represents trade volume
- ‚úÖ Color gradient represents environmental impact intensity
- ‚úÖ Animated flow particles along paths
- ‚úÖ Hover highlights specific trade routes
- ‚úÖ Country labels around perimeter
- ‚úÖ Color legend showing impact scale
- ‚úÖ Export PNG and SVG with timestamp
- ‚úÖ Syncs with global factor selection
- ‚úÖ Minimum 2 countries required

**Visual Elements:**
- **Arcs:** Country segments around circle
- **Ribbons:** Trade flows between countries
- **Particles:** Animated dots showing flow direction
- **Legend:** Color scale for impact intensity

---

## UI/UX Patterns

### 1. Sticky Factor Selector

**Purpose:** Keep environmental factor buttons accessible during scroll

**HTML:**
```html
<div class="factor-selector-sticky" id="factor-selector">
    <h3>üåç Environmental Factor Group</h3>
    <p class="factor-subtitle">Select a category to analyze environmental impacts</p>
    <div class="factor-buttons">
        <button class="factor-btn active" data-factor="air" onclick="selectFactor('air')">
            üí® Air Quality
        </button>
        <button class="factor-btn" data-factor="water" onclick="selectFactor('water')">
            üíß Water
        </button>
        <button class="factor-btn" data-factor="energy" onclick="selectFactor('energy')">
            ‚ö° Energy
        </button>
        <button class="factor-btn" data-factor="land" onclick="selectFactor('land')">
            üå≥ Land
        </button>
        <button class="factor-btn" data-factor="materials" onclick="selectFactor('materials')">
            üèóÔ∏è Materials
        </button>
        <button class="factor-btn" data-factor="employment" onclick="selectFactor('employment')">
            üë• Employment
        </button>
    </div>
</div>
```

**CSS:**
```css
.factor-selector-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 25px 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    color: white;
}

.factor-selector-sticky h3 {
    margin: 0 0 8px 0;
    color: white;
    font-size: 22px;
    font-weight: 700;
}

.factor-subtitle {
    margin: 0 0 20px 0;
    opacity: 0.9;
    font-size: 14px;
}

.factor-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.factor-btn {
    flex: 1;
    min-width: 140px;
    padding: 14px 20px;
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    color: white;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.factor-btn:hover {
    background: rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.factor-btn.active {
    background: white;
    color: #667eea;
    border-color: white;
    box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

@media (max-width: 768px) {
    .factor-btn {
        min-width: calc(50% - 6px);
    }
}
```

**JavaScript:**
```javascript
function selectFactor(factor) {
    currentFactorGroup = factor;
    
    // Update button states
    document.querySelectorAll('.factor-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const activeBtn = document.querySelector(`[data-factor="${factor}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }
    
    // Update all visualizations
    updateCharts();
    updateAdvancedCharts();
    updateStoryline();
    populatePieCountrySelector();
    
    if (typeof syncFlowRingsWithFactor === 'function') {
        syncFlowRingsWithFactor();
    }
    
    if (typeof updateSankeyChart === 'function') {
        updateSankeyChart();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Set initial active state
    const initialBtn = document.querySelector('[data-factor="air"]');
    if (initialBtn) {
        initialBtn.classList.add('active');
    }
});
```

---

### 2. Collapsible Sidebar with Map Expansion

**HTML:**
```html
<div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar">
            <span class="toggle-icon">‚óÄ</span>
        </button>
        <div class="sidebar-content">
            <h3>üåé Country Selection</h3>
            <div class="country-list-scrollable" id="country-list">
                <!-- Country buttons populated dynamically -->
            </div>
        </div>
    </aside>
    
    <main class="main-content" id="main-content">
        <div class="map-container" id="map-container">
            <!-- Leaflet map here -->
        </div>
        <!-- Other content -->
    </main>
</div>
```

**CSS:**
```css
.dashboard-layout {
    display: flex;
    gap: 0;
    min-height: 100vh;
}

.sidebar {
    width: 320px;
    background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
    border-right: 2px solid #e2e8f0;
    position: relative;
    transition: transform 0.4s cubic-bezier(0.4, 0.0, 0.2, 1), 
                width 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    flex-shrink: 0;
    overflow: hidden;
}

.sidebar.collapsed {
    transform: translateX(-100%);
    width: 0;
}

.sidebar-toggle {
    position: absolute;
    top: 20px;
    right: -45px;
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 0 10px 10px 0;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.15);
}

.sidebar-toggle:hover {
    background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
    width: 50px;
}

.sidebar.collapsed .toggle-icon {
    transform: rotate(180deg);
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 18px;
    font-weight: bold;
}

.sidebar-content {
    padding: 25px 20px;
}

.sidebar-content h3 {
    margin: 0 0 20px 0;
    font-size: 20px;
    color: #1e293b;
}

.country-list-scrollable {
    max-height: calc(100vh - 150px);
    overflow-y: auto;
    padding-right: 10px;
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

.country-list-scrollable::-webkit-scrollbar {
    width: 8px;
}

.country-list-scrollable::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.country-list-scrollable::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
    transition: background 0.3s ease;
}

.country-list-scrollable::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.country-btn {
    width: 100%;
    padding: 14px 16px;
    margin-bottom: 8px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    color: #334155;
}

.country-btn:hover {
    border-color: #cbd5e1;
    background: #f8fafc;
    transform: translateX(4px);
}

.country-btn.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.main-content {
    flex: 1;
    transition: margin-left 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    padding: 20px;
}

.map-container {
    width: 100%;
    height: 500px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
}

@media (max-width: 1024px) {
    .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        z-index: 1000;
    }
    
    .main-content {
        margin-left: 0;
    }
}
```

**JavaScript:**
```javascript
function initSidebarToggle() {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebar-toggle');
    const mapContainer = document.getElementById('map-container');
    
    if (!sidebar || !toggle) return;
    
    toggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        
        // Resize map after animation completes
        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
            
            // Resize all charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        }, 400);
    });
}

function populateCountryList() {
    const container = document.getElementById('country-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.keys(COUNTRIES).forEach(code => {
        const country = COUNTRIES[code];
        const btn = document.createElement('button');
        btn.className = 'country-btn';
        btn.dataset.code = code;
        
        if (selectedCountries.has(code)) {
            btn.classList.add('selected');
        }
        
        btn.innerHTML = `
            <span class="fi fi-${code === 'WM' ? 'un' : code.toLowerCase()}"></span>
            <span>${country.name}</span>
        `;
        
        btn.addEventListener('click', () => toggleCountry(code));
        container.appendChild(btn);
    });
}

function toggleCountry(code) {
    if (selectedCountries.has(code)) {
        selectedCountries.delete(code);
    } else {
        selectedCountries.add(code);
    }
    
    // Update UI
    populateCountryList();
    updateCountryCards();
    updateCharts();
    updateAdvancedCharts();
    updateStoryline();
    populatePieCountrySelector();
    
    if (typeof updateFlowVisualization === 'function') {
        updateFlowVisualization();
    }
    
    if (typeof updateSankeyChart === 'function') {
        updateSankeyChart();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    initSidebarToggle();
    populateCountryList();
});
```

---

### 3. Country Card Carousel (3+ Countries)

**HTML:**
```html
<div class="selected-countries-section">
    <h3>üìç Selected Countries</h3>
    <div class="country-cards-container" id="country-cards">
        <!-- Cards populated dynamically -->
    </div>
    <div class="carousel-nav" id="carousel-nav" style="display: none;">
        <button class="nav-btn" onclick="scrollCarousel(-1)" aria-label="Previous">‚óÄ</button>
        <button class="nav-btn" onclick="scrollCarousel(1)" aria-label="Next">‚ñ∂</button>
    </div>
</div>
```

**CSS:**
```css
.selected-countries-section {
    margin: 30px 0;
    padding: 25px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}

.country-cards-container {
    position: relative;
    overflow: hidden;
    padding: 20px 0;
}

.country-cards-container.carousel-mode {
    display: flex;
    scroll-snap-type: x mandatory;
    overflow-x: auto;
    scroll-behavior: smooth;
    gap: 20px;
    padding: 20px;
    margin: 0 -20px;
}

.country-cards-container.carousel-mode::-webkit-scrollbar {
    height: 8px;
}

.country-cards-container.carousel-mode::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

.country-cards-container.carousel-mode::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

.country-card {
    min-width: 300px;
    scroll-snap-align: start;
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 5px solid;
}

.country-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
}

.country-cards-container.side-by-side {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.card-header h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    color: #1e293b;
}

.card-stats {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-label {
    font-size: 13px;
    color: #64748b;
    font-weight: 500;
}

.stat-value {
    font-size: 16px;
    font-weight: 700;
    color: #1e293b;
}

.carousel-nav {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-top: 20px;
}

.nav-btn {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.nav-btn:hover {
    background: linear-gradient(135deg, #5568d3 0%, #653a8a 100%);
    transform: scale(1.1);
}

.nav-btn:active {
    transform: scale(0.95);
}
```

**JavaScript:**
```javascript
function updateCountryCards() {
    const container = document.getElementById('country-cards');
    const navContainer = document.getElementById('carousel-nav');
    
    if (!container) return;
    
    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    
    if (countries.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8;">No countries selected</div>';
        if (navContainer) navContainer.style.display = 'none';
        return;
    }
    
    // Determine display mode
    const isCarousel = countries.length > 2;
    container.className = isCarousel ? 'country-cards-container carousel-mode' : 'country-cards-container side-by-side';
    
    if (navContainer) {
        navContainer.style.display = isCarousel ? 'flex' : 'none';
    }
    
    let html = '';
    countries.forEach(code => {
        const country = COUNTRIES[code];
        const total = calculateTotalForCountry(code, currentFactorGroup);
        const domestic = calculateTotalByFlow(code, currentFactorGroup, 'domestic');
        const exports = calculateTotalByFlow(code, currentFactorGroup, 'exports');
        const imports = calculateTotalByFlow(code, currentFactorGroup, 'imports');
        
        html += `
            <div class="country-card" style="border-left-color: ${country.color}">
                <div class="card-header">
                    <span class="fi fi-${code === 'WM' ? 'un' : code.toLowerCase()}" style="font-size: 32px;"></span>
                    <h4>${country.name}</h4>
                </div>
                <div class="card-stats">
                    <div class="stat-item">
                        <span class="stat-label">Total Impact</span>
                        <span class="stat-value" style="color: ${country.color}">${formatNumber(total)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üè≠ Domestic</span>
                        <span class="stat-value">${formatNumber(domestic)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üì§ Exports</span>
                        <span class="stat-value">${formatNumber(exports)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">üì• Imports</span>
                        <span class="stat-value">${formatNumber(imports)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Region</span>
                        <span class="stat-value">${country.region}</span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function scrollCarousel(direction) {
    const container = document.querySelector('.country-cards-container.carousel-mode');
    if (!container) return;
    
    const scrollAmount = 320; // Card width + gap
    container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
    });
}
```

---

### 4. Country Flags (CSS Flag Icons)

**CDN Link:**
```html
<!-- Add to <head> -->
<link href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" rel="stylesheet">
```

**Usage Examples:**
```html
<!-- Basic flag -->
<span class="fi fi-us"></span>

<!-- Flag with custom size -->
<span class="fi fi-gb" style="font-size: 24px;"></span>

<!-- Flag in button -->
<button>
    <span class="fi fi-de"></span>
    Germany
</button>

<!-- Flag with animation -->
<span class="fi fi-fr animated-flag"></span>
```

**CSS Animations:**
```css
.fi {
    display: inline-block;
    width: 24px;
    height: 18px;
    border-radius: 3px;
    margin-right: 8px;
    vertical-align: middle;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

/* Wave animation */
@keyframes wave {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-3deg); }
    75% { transform: rotate(3deg); }
}

.animated-flag {
    animation: wave 2s ease-in-out infinite;
    transform-origin: bottom center;
}

/* Hover zoom */
.country-btn:hover .fi {
    transform: scale(1.15);
    transition: transform 0.3s ease;
}

/* Pulse on selection */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
    100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
}

.country-btn.selected .fi {
    animation: pulse 2s infinite;
}
```

---

## Data Processing Functions

### 1. CSV Loading with PapaParse

**Dependencies:**
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
```

**Implementation:**
```javascript
/**
 * Load a CSV file from URL
 * @param {string} url - Full URL to CSV file
 * @returns {Promise<Array>} - Parsed CSV data as array of objects
 */
function loadCSV(url) {
    return new Promise((resolve, reject) => {
        Papa.parse(url, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: (results) => {
                if (results.errors.length > 0) {
                    console.warn(`Parsing warnings for ${url}:`, results.errors);
                }
                
                debugLog(`‚úì Loaded ${url.split('/').pop()}: ${results.data.length} rows`);
                resolve(results.data);
            },
            error: (error) => {
                console.error(`Failed to load ${url}:`, error);
                loadingErrors.push({ url, error: error.message });
                debugLog(`‚úó Failed to load ${url}: ${error.message}`, true);
                resolve(null); // Don't reject - allow graceful failure
            }
        });
    });
}

/**
 * Load all data files for the dashboard
 */
async function loadAllData() {
    showStatus('üîÑ Loading reference data...');
    
    // Step 1: Load reference files first (industry and factor)
    const [industryData, factorData] = await Promise.all([
        loadCSV(`${DATA_BASE_PATH}/industry.csv`),
        loadCSV(`${DATA_BASE_PATH}/factor.csv`)
    ]);
    
    // Populate lookup tables
    if (industryData) {
        industryData.forEach(row => {
            industryLookup[row.industry_id] = row;
        });
        debugLog(`‚úì Indexed ${Object.keys(industryLookup).length} industries`);
    }
    
    if (factorData) {
        factorData.forEach(row => {
            factorLookup[row.factor_id] = row;
        });
        debugLog(`‚úì Indexed ${Object.keys(factorLookup).length} factors`);
    }
    
    // Step 2: Load country trade flow data
    showStatus('üåç Loading country trade data...');
    const countryPromises = [];
    
    Object.keys(COUNTRIES).forEach(code => {
        TRADE_FLOWS.forEach(flow => {
            countryPromises.push(loadCountryFlow(code, flow));
        });
    });
    
    await Promise.all(countryPromises);
    
    dataLoadingComplete = true;
    
    const errorMsg = loadingErrors.length > 0 ? 
        ` (${loadingErrors.length} errors logged)` : '';
    showStatus(`‚úÖ Data load complete${errorMsg}`, loadingErrors.length > 0);
    
    // Step 3: Initial render
    updateCountryCards();
    updateCharts();
    updateAdvancedCharts();
    updateStoryline();
    populatePieCountrySelector();
    
    if (typeof initFlowRingsSimple === 'function') {
        initFlowRingsSimple();
    }
    
    if (typeof updateSankeyChart === 'function') {
        updateSankeyChart();
    }
}

/**
 * Load trade flow data for a specific country and flow type
 * @param {string} code - Country code
 * @param {string} flow - Flow type ('domestic', 'exports', 'imports')
 */
async function loadCountryFlow(code, flow) {
    const basePath = `${DATA_BASE_PATH}/${code}/${flow}`;
    
    try {
        const [trade, tradeFactor] = await Promise.all([
            loadCSV(`${basePath}/trade.csv`),
            loadCSV(`${basePath}/trade_factor.csv`)
        ]);
        
        // Initialize nested structure if needed
        if (!tradeData[code]) tradeData[code] = {};
        
        tradeData[code][flow] = {
            trade: trade || [],
            trade_factor: tradeFactor || []
        };
        
        // Build trade lookup for quick access
        if (trade) {
            trade.forEach(row => {
                tradeLookup[row.trade_id] = row;
            });
        }
        
        debugLog(`‚úì Loaded ${code}/${flow}: ${trade ? trade.length : 0} trades, ${tradeFactor ? tradeFactor.length : 0} factors`);
    } catch (error) {
        debugLog(`‚úó Failed ${code}/${flow}: ${error.message}`, true);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadAllData();
});
```

**Error Handling Best Practices:**
- ‚úÖ Never crash on missing files
- ‚úÖ Store errors in array for debugging
- ‚úÖ Continue loading other files
- ‚úÖ Show user-friendly status messages
- ‚úÖ Log detailed errors to console
- ‚úÖ Return null instead of rejecting promises

---

### 2. Number Formatting

**Implementation:**
```javascript
/**
 * Format numbers with K/M/B suffixes
 * @param {number} num - Number to format
 * @returns {string} - Formatted string
 */
function formatNumber(num) {
    if (num === 0 || num === null || isNaN(num)) return '0';
    
    const absNum = Math.abs(num);
    const sign = num < 0 ? '-' : '';
    
    if (absNum >= 1e12) return sign + (absNum / 1e12).toFixed(2) + 'T';
    if (absNum >= 1e9)  return sign + (absNum / 1e9).toFixed(2) + 'B';
    if (absNum >= 1e6)  return sign + (absNum / 1e6).toFixed(2) + 'M';
    if (absNum >= 1e3)  return sign + (absNum / 1e3).toFixed(2) + 'K';
    
    return sign + absNum.toFixed(2);
}

/**
 * Format currency values
 * @param {number} num - Number to format
 * @param {string} currency - Currency symbol (default: '$')
 * @returns {string} - Formatted currency string
 */
function formatCurrency(num, currency = '$') {
    return currency + formatNumber(num);
}

/**
 * Format percentage values
 * @param {number} num - Number to format (0-100)
 * @param {number} decimals - Decimal places (default: 1)
 * @returns {string} - Formatted percentage
 */
function formatPercent(num, decimals = 1) {
    return num.toFixed(decimals) + '%';
}

// Usage examples:
formatNumber(1234567890);        // "1.23B"
formatNumber(5678900);           // "5.68M"
formatNumber(45678);             // "45.68K"
formatNumber(123.456);           // "123.46"
formatCurrency(1234567);         // "$1.23M"
formatPercent(45.678);           // "45.7%"
formatPercent(45.678, 2);        // "45.68%"
```

---

### 3. Data Aggregation Functions

**By Country:**
```javascript
/**
 * Calculate total impact for a country across all flows
 * @param {string} code - Country code
 * @param {string} factorGroup - Factor group name
 * @returns {number} - Total impact value
 */
function calculateTotalForCountry(code, factorGroup) {
    let total = 0;
    const flows = ['domestic', 'exports', 'imports'];
    
    flows.forEach(flow => {
        total += calculateTotalByFlow(code, factorGroup, flow);
    });
    
    return total;
}
```

**By Flow:**
```javascript
/**
 * Calculate total impact for a specific trade flow
 * @param {string} code - Country code
 * @param {string} factorGroup - Factor group name
 * @param {string} flow - Flow type ('domestic', 'exports', 'imports')
 * @returns {number} - Total impact value
 */
function calculateTotalByFlow(code, factorGroup, flow) {
    let total = 0;
    
    if (!tradeData[code] || !tradeData[code][flow]) {
        return 0;
    }
    
    const factorData = tradeData[code][flow].trade_factor || [];
    
    factorData.forEach(row => {
        const factor = factorLookup[row.factor_id];
        if (factor && getFactorGroup(factor.extension) === factorGroup) {
            total += parseFloat(row.impact_value) || 0;
        }
    });
    
    return total;
}
```

**By Industry:**
```javascript
/**
 * Aggregate impact values by industry across selected countries
 * @param {Array<string>} countries - Array of country codes
 * @param {string} factorGroup - Factor group name
 * @returns {Object} - Industry totals {industryName: value}
 */
function aggregateByIndustry(countries, factorGroup) {
    const industryTotals = {};
    
    countries.forEach(code => {
        if (!COUNTRIES[code]) return;
        
        ['domestic', 'exports', 'imports'].forEach(flow => {
            if (!tradeData[code] || !tradeData[code][flow]) return;
            
            const trades = tradeData[code][flow].trade || [];
            const factors = tradeData[code][flow].trade_factor || [];
            
            trades.forEach(trade => {
                const industry = industryLookup[trade.industry_id];
                if (!industry) return;
                
                const industryName = industry.name || 'Unknown';
                if (!industryTotals[industryName]) {
                    industryTotals[industryName] = 0;
                }
                
                // Sum impacts for this trade
                factors
                    .filter(f => f.trade_id === trade.trade_id)
                    .forEach(factorRow => {
                        const factor = factorLookup[factorRow.factor_id];
                        if (factor && getFactorGroup(factor.extension) === factorGroup) {
                            industryTotals[industryName] += parseFloat(factorRow.impact_value) || 0;
                        }
                    });
            });
        });
    });
    
    return industryTotals;
}
```

---

## Performance & Debugging

### 1. Prevent Runaway Loops (CRITICAL)

**Problem:** Requesting data for non-existent countries causes 404 errors ‚Üí retry loops ‚Üí CPU overload ‚Üí browser crash

**Solution:**
```javascript
// ALWAYS use the whitelist
const AVAILABLE_COUNTRIES = ['US', 'CA', 'BR', 'GB', 'DE', 'FR', 'IT', 'RU', 'CN', 'JP', 'IN', 'KR', 'AU', 'WM'];

/**
 * Validate country code before loading
 * @param {string} countryCode - Country code to validate
 * @returns {boolean} - True if country exists in dataset
 */
function isValidCountry(countryCode) {
    return AVAILABLE_COUNTRIES.includes(countryCode);
}

/**
 * Safe country data loading with validation
 * @param {string} countryCode - Country code
 * @returns {Promise} - Resolves with data or null
 */
function loadCountryDataSafe(countryCode) {
    // CRITICAL: Validate before loading
    if (!isValidCountry(countryCode)) {
        console.warn(`‚ùå Country ${countryCode} not in dataset, skipping`);
        return Promise.resolve(null);
    }
    
    return loadCSV(url)
        .then(data => {
            if (!data) {
                console.warn(`No data returned for ${countryCode}`);
                return null;
            }
            return data;
        })
        .catch(error => {
            console.warn(`Error loading ${countryCode}:`, error);
            // CRITICAL: DON'T RETRY - return null and move on
            return null;
        });
}
```

**Critical Rules:**
- ‚ùå NEVER request countries not in `AVAILABLE_COUNTRIES`
- ‚ùå NEVER retry failed requests automatically
- ‚úÖ ALWAYS return null on failure, don't throw
- ‚úÖ Log warnings, don't show error alerts
- ‚úÖ Continue with remaining data loads

---

### 2. Debug Panel

**Purpose:** Show data loading progress during development

**HTML:**
```html
<div class="debug-panel" id="debug-panel">
    <div class="debug-header">
        <h4>üîß Debug Console</h4>
        <button onclick="toggleDebugPanel()">Minimize</button>
        <button onclick="clearDebugLog()">Clear</button>
    </div>
    <div class="debug-log" id="debug-log">
        <!-- Logs appear here -->
    </div>
</div>
```

**CSS:**
```css
.debug-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 450px;
    max-height: 350px;
    background: rgba(15, 23, 42, 0.98);
    border-radius: 12px;
    color: #fff;
    font-family: 'Courier New', 'Consolas', monospace;
    font-size: 12px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    z-index: 9999;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    /* Hide in production */
    display: none;
}

.debug-panel.active {
    display: block;
}

.debug-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.debug-header h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 600;
}

.debug-header button {
    padding: 6px 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-size: 11px;
    transition: all 0.2s ease;
}

.debug-header button:hover {
    background: rgba(255,255,255,0.2);
}

.debug-log {
    padding: 12px 16px;
    max-height: 280px;
    overflow-y: auto;
}

.debug-log::-webkit-scrollbar {
    width: 8px;
}

.debug-log::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
}

.debug-log::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
}

.log-entry {
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    line-height: 1.5;
}

.log-entry.success {
    color: #10b981;
}

.log-entry.error {
    color: #ef4444;
}

.log-entry.warning {
    color: #f59e0b;
}

.log-entry.info {
    color: #3b82f6;
}
```

**JavaScript:**
```javascript
/**
 * Log message to debug panel
 * @param {string} message - Message to log
 * @param {boolean} isError - Is this an error message
 * @param {string} level - Log level: 'success', 'error', 'warning', 'info'
 */
function debugLog(message, isError = false, level = null) {
    const debugDiv = document.getElementById('debug-log');
    if (!debugDiv) return;
    
    const timestamp = new Date().toLocaleTimeString();
    const logLevel = level || (isError ? 'error' : 'success');
    const icons = {
        success: '‚úì',
        error: '‚úó',
        warning: '‚ö†',
        info: '‚Ñπ'
    };
    const icon = icons[logLevel] || '‚Ä¢';
    
    const entry = document.createElement('div');
    entry.className = `log-entry ${logLevel}`;
    entry.textContent = `[${timestamp}] ${icon} ${message}`;
    
    debugDiv.appendChild(entry);
    debugDiv.scrollTop = debugDiv.scrollHeight;
    
    console.log(message);
}

/**
 * Clear debug log
 */
function clearDebugLog() {
    const debugDiv = document.getElementById('debug-log');
    if (debugDiv) {
        debugDiv.innerHTML = '';
    }
    debugLog('Debug log cleared', false, 'info');
}

/**
 * Toggle debug panel visibility
 */
function toggleDebugPanel() {
    const panel = document.getElementById('debug-panel');
    if (panel) {
        panel.classList.toggle('active');
    }
}

/**
 * Show status message to user
 * @param {string} message - Status message
 * @param {boolean} isError - Is this an error
 */
function showStatus(message, isError = false) {
    const statusEl = document.getElementById('loading-status');
    if (statusEl) {
        statusEl.textContent = message;
        statusEl.className = isError ? 'status-message error' : 'status-message';
        statusEl.style.display = 'block';
        
        if (!isError && dataLoadingComplete) {
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
    }
    debugLog(message, isError, isError ? 'error' : 'info');
}

// Keyboard shortcut: Ctrl+D to toggle debug panel
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        toggleDebugPanel();
    }
});

// Show debug panel in development
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
    document.addEventListener('DOMContentLoaded', () => {
        const panel = document.getElementById('debug-panel');
        if (panel) {
            panel.classList.add('active');
        }
    });
}
```

---

### 3. Chart Resize Handling

**Problem:** Charts don't resize properly when window or container changes

**Solution:**
```javascript
/**
 * Debounced window resize handler
 */
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        resizeAllCharts();
    }, 250);
});

/**
 * Resize all ECharts instances
 */
function resizeAllCharts() {
    Object.entries(charts).forEach(([key, chart]) => {
        if (chart && typeof chart.resize === 'function') {
            try {
                chart.resize();
            } catch (error) {
                console.warn(`Failed to resize chart ${key}:`, error);
            }
        }
    });
    
    // Resize Leaflet map
    if (map && typeof map.invalidateSize === 'function') {
        map.invalidateSize();
    }
    
    debugLog('Charts resized', false, 'info');
}

/**
 * Resize observer for container changes
 */
const resizeObserver = new ResizeObserver(entries => {
    entries.forEach(entry => {
        const chartId = entry.target.id;
        const chartKey = chartId.replace('chart-', '');
        
        if (charts[chartKey] && typeof charts[chartKey].resize === 'function') {
            charts[chartKey].resize();
        }
    });
});

// Observe all chart containers
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[id^="chart-"]').forEach(container => {
        resizeObserver.observe(container);
    });
});

/**
 * Resize after sidebar toggle
 * @param {number} delay - Delay in ms (default: 400)
 */
function resizeAfterAnimation(delay = 400) {
    setTimeout(() => {
        resizeAllCharts();
    }, delay);
}
```

---

### 4. Gauge Chart Fix (Overflow Issue)

**Problem:** Gauges overflow container on initial load at 100% zoom, but appear correct after zoom change

**Root Cause:** ECharts calculates dimensions before container is fully rendered

**Solution:**
```javascript
function updateGaugeChart() {
    const container = document.getElementById('gauge-container');
    if (!container) return;
    
    // Clear existing gauges
    container.innerHTML = '';
    Object.keys(charts).forEach(key => {
        if (key.startsWith('gauge-')) {
            charts[key].dispose();
            delete charts[key];
        }
    });

    const countries = Array.from(selectedCountries).filter(code => COUNTRIES[code]);
    if (countries.length === 0) return;
    
    const allValues = countries.map(code => calculateTotalForCountry(code, currentFactorGroup));
    const maxValue = Math.max(...allValues);
    
    countries.forEach(code => {
        // ... gauge creation code ...
        
        charts[`gauge-${code}`] = echarts.init(chartDiv);
        charts[`gauge-${code}`].setOption(option);
    });
    
    // ‚ö° CRITICAL FIX: Force resize after DOM settles
    setTimeout(() => {
        Object.keys(charts).forEach(key => {
            if (key.startsWith('gauge-') && charts[key]) {
                try {
                    charts[key].resize();
                } catch (error) {
                    console.warn(`Failed to resize gauge ${key}:`, error);
                }
            }
        });
    }, 150); // Increased from 100ms for more reliability
    
    // Also resize on window resize
    const resizeGauges = () => {
        Object.keys(charts).forEach(key => {
            if (key.startsWith('gauge-') && charts[key]) {
                charts[key].resize();
            }
        });
    };
    
    // Remove previous listener to avoid duplicates
    window.removeEventListener('resize', resizeGauges);
    window.addEventListener('resize', resizeGauges);
}
```

**Additional Fix - CSS Container Sizing:**
```css
.gauge-item {
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-height: 240px;
    max-height: 260px; /* Prevent overflow */
    display: flex;
    flex-direction: column;
    overflow: hidden; /* CRITICAL: Clip overflowing content */
}

.gauge-chart {
    flex: 1;
    width: 100%;
    min-height: 180px;
    max-height: 200px; /* Enforce maximum */
    position: relative; /* Contain absolutely positioned elements */
}
```

---

### 5. Memory Management

**Problem:** Multiple chart instances can cause memory leaks

**Solution:**
```javascript
/**
 * Dispose a chart instance properly
 * @param {string} chartKey - Chart key in charts object
 */
function disposeChart(chartKey) {
    if (charts[chartKey]) {
        try {
            charts[chartKey].dispose();
            delete charts[chartKey];
            debugLog(`Chart ${chartKey} disposed`, false, 'info');
        } catch (error) {
            console.warn(`Failed to dispose chart ${chartKey}:`, error);
        }
    }
}

/**
 * Dispose all charts
 */
function disposeAllCharts() {
    Object.keys(charts).forEach(key => {
        disposeChart(key);
    });
    debugLog('All charts disposed', false, 'info');
}

/**
 * Clean up before page unload
 */
window.addEventListener('beforeunload', () => {
    disposeAllCharts();
    
    // Clear D3 visualizations
    d3.selectAll('svg').remove();
    
    // Clear intervals/timeouts
    clearTimeout(resizeTimeout);
});
```

---

## Integration Guidelines

### 1. Adding a New Chart

**Template:**
```javascript
// Step 1: Add HTML container
<div class="chart-container">
    <h3>My New Chart</h3>
    <div id="chart-mynewchart" style="width: 100%; height: 400px;"></div>
</div>

// Step 2: Create update function
function updateMyNewChart() {
    const chartDiv = document.getElementById('chart-mynewchart');
    if (!chartDiv) return;
    
    // Initialize chart if not exists
    if (!charts.mynewchart) {
        charts.mynewchart = echarts.init(chartDiv);
    }
    
    // Get data
    const countries = Array.from(selectedCountries);
    const data = processDataForMyChart(countries, currentFactorGroup);
    
    // Configure options
    const option = {
        // ... your chart configuration ...
    };
    
    // Render
    charts.mynewchart.setOption(option, true);
}

// Step 3: Add to update chain
function updateAdvancedCharts() {
    if (!dataLoadingComplete) return;
    
    updateBubbleChart();
    updatePieChart();
    // ... existing charts ...
    updateMyNewChart(); // ‚Üê Add here
}

// Step 4: Add resize handling
window.addEventListener('resize', () => {
    if (charts.mynewchart) {
        charts.mynewchart.resize();
    }
});

// Step 5: Add disposal
function disposeAllCharts() {
    // ... existing disposals ...
    disposeChart('mynewchart'); // ‚Üê Add here
}
```

---

### 2. Adding a New Factor Group

**Steps:**
```javascript
// 1. Add to FACTOR_GROUP_MAPPING
const FACTOR_GROUP_MAPPING = {
    'air': ['Air', 'Emissions to air', 'GHG emissions'],
    'water': ['Water', 'Emissions to water', 'Water use'],
    'energy': ['Energy', 'Energy use'],
    'land': ['Land', 'Land use'],
    'materials': ['Materials', 'Material use', 'Resources'],
    'employment': ['Employment', 'Labour'],
    // Add new factor group
    'biodiversity': ['Biodiversity', 'Species', 'Habitat', 'Ecosystem'] // ‚Üê New
};

// 2. Add button to HTML
<button class="factor-btn" data-factor="biodiversity" onclick="selectFactor('biodiversity')">
    ü¶ã Biodiversity
</button>

// 3. No code changes needed - existing functions use dynamic mapping!
// The getFactorGroup() function will automatically recognize the new keywords
```

---

### 3. Adding a New Country

**Requirements:**
1. ‚úÖ Data must exist in dataset at `https://github.com/ModelEarth/trade-data/tree/main/year/2019/[COUNTRY_CODE]`
2. ‚úÖ Must have all 6 required files (domestic, exports, imports √ó trade + trade_factor)

**Steps:**
```javascript
// 1. Add to COUNTRIES object
const COUNTRIES = {
    // ... existing countries ...
    MX: { 
        name: 'Mexico', 
        coords: [23.63, -102.55], 
        flag: 'üá≤üáΩ', 
        color: '#E91E63', 
        region: 'Americas' 
    } // ‚Üê New country
};

// 2. Add to AVAILABLE_COUNTRIES whitelist
const AVAILABLE_COUNTRIES = [
    'US', 'CA', 'BR', 'GB', 'DE', 'FR', 'IT', 'RU', 
    'CN', 'JP', 'IN', 'KR', 'AU', 'WM',
    'MX' // ‚Üê Add here
];

// 3. That's it! The country will automatically appear in:
//    - Sidebar country list
//    - Map markers (if initMap is implemented)
//    - All charts and visualizations
//    - Dropdowns and selectors
```

---

### 4. Syncing Charts with Global State

**Pattern:**
```javascript
// Global state change triggers all updates
function updateGlobalState(changes) {
    // Update state
    if (changes.countries) {
        selectedCountries = changes.countries;
    }
    
    if (changes.factor) {
        currentFactorGroup = changes.factor;
    }
    
    // Trigger all visualizations
    updateCountryCards();
    updateCharts();
    updateAdvancedCharts();
    updateStoryline();
    populatePieCountrySelector();
    
    // Update advanced visualizations
    if (typeof syncFlowRingsWithFactor === 'function') {
        syncFlowRingsWithFactor();
    }
    
    if (typeof updateSankeyChart === 'function') {
        updateSankeyChart();
    }
    
    // Update map markers
    if (typeof updateMapMarkers === 'function') {
        updateMapMarkers();
    }
    
    // Update URL (optional - for shareable links)
    if (typeof updateURL === 'function') {
        updateURL();
    }
}
```

---

## CSS Style Standards

### Color Palette (Notion-inspired)
```css
:root {
    /* Primary colors */
    --primary-bg: #ffffff;
    --secondary-bg: #f7f6f3;
    --tertiary-bg: #f8fafc;
    
    /* Accent colors */
    --accent-primary: #667eea;
    --accent-secondary: #764ba2;
    --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    
    /* Text colors */
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --text-muted: #94a3b8;
    --text-white: #ffffff;
    
    /* Border colors */
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-dark: #94a3b8;
    
    /* Status colors */
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
    --info: #3b82f6;
    
    /* Chart colors */
    --chart-blue: #3b82f6;
    --chart-green: #10b981;
    --chart-orange: #f59e0b;
    --chart-red: #ef4444;
    --chart-purple: #8b5cf6;
    --chart-teal: #14b8a6;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --shadow-xl: 0 12px 32px rgba(0,0,0,0.15);
    
    /* Border radius */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-xl: 20px;
}
```

### Typography
```css
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 
                 'Oxygen', 'Ubuntu', 'Cantarell', 'Helvetica Neue', sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--primary-bg);
}

h1 { 
    font-size: 2.75rem; 
    font-weight: 700; 
    margin: 0 0 1.25rem 0;
    line-height: 1.2;
}

h2 { 
    font-size: 2.25rem; 
    font-weight: 600; 
    margin: 0 0 1rem 0;
    line-height: 1.3;
}

h3 { 
    font-size: 1.75rem; 
    font-weight: 600; 
    margin: 0 0 0.875rem 0;
    line-height: 1.4;
}

h4 { 
    font-size: 1.375rem; 
    font-weight: 600; 
    margin: 0 0 0.75rem 0;
}

p { 
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
}

.subtitle {
    font-size: 1.125rem;
    color: var(--text-muted);
    margin: -0.5rem 0 1.5rem 0;
}
```

### Utility Classes
```css
/* Spacing */
.mt-1 { margin-top: 0.5rem; }
.mt-2 { margin-top: 1rem; }
.mt-3 { margin-top: 1.5rem; }
.mt-4 { margin-top: 2rem; }

.mb-1 { margin-bottom: 0.5rem; }
.mb-2 { margin-bottom: 1rem; }
.mb-3 { margin-bottom: 1.5rem; }
.mb-4 { margin-bottom: 2rem; }

.p-1 { padding: 0.5rem; }
.p-2 { padding: 1rem; }
.p-3 { padding: 1.5rem; }
.p-4 { padding: 2rem; }

/* Elevation */
.elevation-1 { box-shadow: var(--shadow-sm); }
.elevation-2 { box-shadow: var(--shadow-md); }
.elevation-3 { box-shadow: var(--shadow-lg); }
.elevation-4 { box-shadow: var(--shadow-xl); }

/* Borders */
.border { border: 1px solid var(--border-light); }
.border-medium { border: 1px solid var(--border-medium); }
.border-dark { border: 1px solid var(--border-dark); }

/* Rounded corners */
.rounded-sm { border-radius: var(--radius-sm); }
.rounded { border-radius: var(--radius-md); }
.rounded-lg { border-radius: var(--radius-lg); }
.rounded-xl { border-radius: var(--radius-xl); }
.rounded-full { border-radius: 9999px; }

/* Text alignment */
.text-left { text-align: left; }
.text-center { text-align: center; }
.text-right { text-align: right; }

/* Text colors */
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: --text-muted); }
.text-success { color: var(--success); }
.text-warning { color: var(--warning); }
.text-error { color: var(--error); }
```

---

## Quick Reference

### Essential Links
- **Main comparison page:** https://model.earth/comparison
- **Dev folder (Antariksh):** https://model.earth/comparison/dev/antariksh/
- **Trade data repo:** https://github.com/ModelEarth/trade-data
- **Factor definitions:** https://github.com/ModelEarth/trade-data/blob/main/year/2019/factor.csv
- **Industry definitions:** https://github.com/ModelEarth/trade-data/blob/main/year/2019/industry.csv
- **Style samples:** https://model.earth/localsite/css/styles/

### Key CDN Links
```html
<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<!-- Flag Icons -->
<link href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" rel="stylesheet">

<!-- Leaflet (for maps) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
```

### Best Practices Checklist
- ‚úÖ Always validate country codes against `AVAILABLE_COUNTRIES`
- ‚úÖ Handle errors gracefully without crashing
- ‚úÖ Position legends outside charts to prevent overlap
- ‚úÖ Use consistent color schemes across visualizations
- ‚úÖ Sync chart updates with global state changes
- ‚úÖ Provide export options (PNG/SVG) for major visualizations
- ‚úÖ Implement responsive design with proper resize handling
- ‚úÖ Add loading indicators for async operations
- ‚úÖ Test with different numbers of selected countries (0, 1, 2, 3+)
- ‚úÖ Dispose charts properly to avoid memory leaks
- ‚úÖ Use debouncing for resize/scroll event handlers
- ‚úÖ Log errors to debug panel, not alert dialogs
- ‚úÖ Include tooltips with country flags and formatted numbers
- ‚úÖ Keep chart libraries in CDN (no local dependencies)
- ‚úÖ Document any new patterns in this CLAUDE.md file

---

## Version History

**v1.0.0** - December 2024
- ‚úÖ Initial comprehensive documentation
- ‚úÖ 8 reusable chart components with production code
- ‚úÖ Complete UI/UX patterns library
- ‚úÖ Data processing functions
- ‚úÖ Performance optimization guide
- ‚úÖ Integration guidelines
- ‚úÖ CSS style standards

---

## Contributing

When you create new charts or improve existing ones:

1. **Test thoroughly** with different country selections
2. **Extract reusable code** into this document
3. **Add code comments** explaining complex logic
4. **Include usage examples** and common issues
5. **Update the Table of Contents** if adding new sections
6. **Follow the established patterns** for consistency

This documentation grows with the project. üöÄ

---

*Generated for Model Earth Comparison Dashboard Project*  
*Last Updated: December 2024*